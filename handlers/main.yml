# SPDX-License-Identifier: MIT
---
# EL 7 workaround for https://bugzilla.redhat.com/show_bug.cgi?id=1152027
- name: Fix default kernel boot parameters
  shell: |-
    set -o pipefail
    grubby --info=DEFAULT | awk '/^args/ {print $0}'
    cat {{ __bootloader_default_grub }}
    eval $(grubby --info=DEFAULT | awk '/^args/ {print $0}')
    sed -i -e "s|^GRUB_CMDLINE_LINUX=.*|GRUB_CMDLINE_LINUX=\"$args\"|" \
      {{ __bootloader_default_grub }}
    cat {{ __bootloader_default_grub }}
  changed_when: true
  when:
    - ansible_distribution in ['CentOS', 'RedHat']
    - ansible_distribution_version is version('8', '<')

- name: Reboot system
  include_tasks: tasks/reboot.yml

# This doesn't work on EL 7. EL 7 has it's workaround in tasks/main.yml
- name: Regenerate grub config
  command: grub2-mkconfig -o {{ __bootloader_grub_conf }}
  when: >-
    not (ansible_distribution in ['CentOS', 'RedHat'] and
    ansible_distribution_version is version('8', '<'))
